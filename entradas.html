<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Módulo de Entradas - Ingreso de Mercancía</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      text-align: center;
      margin-bottom: 20px;
    }
    .back-btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
      margin-bottom: 20px;
      cursor: pointer;
    }
    .back-btn:hover { background-color: #0056b3; }

    .form-group { margin-bottom: 15px; }
    .form-group label { font-weight: bold; margin-bottom: 5px; display: block; }

    select, input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #fff;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
    }
    table thead { background-color: #e9ecef; }

    .btn-load {
      background-color: #007bff;
      color: #fff;
      margin-bottom: 20px;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
    }
    .btn-load:hover { opacity: 0.9; }

    .btn-add-item {
      margin-top: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 5px 10px;
    }
    .btn-add-item:hover { opacity: 0.9; }

    .btn-delete-item {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 2px 5px;
      font-size: 0.9em;
    }
    .btn-delete-item:hover { opacity: 0.9; }

    .button-group {
      text-align: center;
      margin-top: 20px;
    }
    .button-group button {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    .btn-submit { background-color: #28a745; color: #fff; }
    .btn-reset  { background-color: #dc3545; color: #fff; }

    #ordenInfo {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 20px;
      display: none;
    }

    /* Sección Responsable */
    .firma-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
      background: #fafafa;
    }
    .firma-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .firma-grid .form-group { margin: 0; }

    /* Sección Historial */
    #historialSection { margin-top: 40px; display: none; }
    #tablaHistorial th, #tablaHistorial td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 0.9em;
      vertical-align: middle;
    }
    .btn-view-acta {
      background-color: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 5px 10px;
      font-size: 0.9em;
    }
    .btn-view-acta:hover { opacity: 0.9; }
  </style>
</head>
<body>
  <!-- Volver -->
  <button class="back-btn" onclick="window.location.href='index.html'">Volver al Menú</button>

  <div class="container">
    <h1>Módulo de Entradas</h1>

    <!-- Selección de Orden de Compra -->
    <div class="form-group">
      <label for="ordenCompraSelect">Seleccione Orden de Compra:</label>
      <select id="ordenCompraSelect">
        <option value="">Seleccione una orden</option>
      </select>
      <button type="button" class="btn-load" onclick="cargarOrden()">Cargar Orden</button>
      <button type="button" class="btn-load" onclick="toggleHistorial()">Ver Historial de Actas</button>
    </div>

    <!-- Formulario de Ingreso -->
    <form id="entradaForm">
      <div id="ordenInfo">
        <h3>Detalles de la Orden de Compra</h3>
        <div id="detalleOrden"></div>
      </div>

      <h3>Ingreso de Lote, Registro Sanitario y Fecha de Vencimiento</h3>
      <table id="tablaEntradas">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Unidad</th>
            <th>Cant.</th>
            <th>Precio Unit</th>
            <th>Total Unit</th>
            <th>Lote</th>
            <th>F.Venc.</th>
            <th>Reg. San</th>
            <th>Cant. Revisada</th>
            <th>Transp/Manip (S/N)</th>
            <th>Cadena Frío (S/N)</th>
            <th>Aprobado (S/N)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button type="button" class="btn-add-item" onclick="agregarFilaManual()">Agregar Ítem Manual</button>

      <div class="form-group" style="margin-top:15px;">
        <label for="totalEntrada">Total de Entrada:</label>
        <input type="number" id="totalEntrada" step="0.01" readonly>
      </div>

      <!-- Responsable de recepción -->
      <div class="firma-card">
        <h3 style="text-align:left; margin-top:0;">Firma del Responsable de Recepción</h3>
        <div class="firma-grid">
          <div class="form-group">
            <label for="respNombre">Nombre:</label>
            <input type="text" id="respNombre" placeholder="Nombre del responsable" required>
          </div>
          <div class="form-group">
            <label for="respCargo">Cargo:</label>
            <input type="text" id="respCargo" placeholder="Cargo del responsable" required>
          </div>
          <div class="form-group">
            <label for="respFecha">Fecha:</label>
            <input type="date" id="respFecha" required>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button type="submit" class="btn-submit">Guardar Entrada</button>
        <button type="reset" class="btn-reset">Limpiar</button>
        <button type="button" class="btn-load" onclick="generarActa()">Generar Acta de Recepción</button>
      </div>
    </form>
  </div>

  <!-- Historial -->
  <div class="container" id="historialSection">
    <h2>Historial de Actas de Recepción</h2>
    <table id="tablaHistorial">
      <thead>
        <tr>
          <th>ID Entrada</th>
          <th>Orden ID</th>
          <th>Fecha Ingreso</th>
          <th>Total Entrada</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let compras = [];
    let compraSeleccionada = null;
    let entradas = [];

    const ordenCompraSelect = document.getElementById('ordenCompraSelect');
    const detalleOrdenDiv   = document.getElementById('detalleOrden');
    const ordenInfoDiv      = document.getElementById('ordenInfo');
    const tablaEntradasBody = document.querySelector('#tablaEntradas tbody');
    const entradaForm       = document.getElementById('entradaForm');
    const totalEntradaInput = document.getElementById('totalEntrada');

    const respNombre = document.getElementById('respNombre');
    const respCargo  = document.getElementById('respCargo');
    const respFecha  = document.getElementById('respFecha');

    const historialSection  = document.getElementById('historialSection');
    const tablaHistorialBody= document.querySelector('#tablaHistorial tbody');

    document.addEventListener('DOMContentLoaded', () => {
      const storedCompras = localStorage.getItem('compras');
      if (storedCompras) compras = JSON.parse(storedCompras);

      compras.forEach(compra => {
        const option = document.createElement('option');
        option.value = compra.id;
        option.textContent = `Orden #${compra.id} - ${compra.fecha}`;
        ordenCompraSelect.appendChild(option);
      });

      // Fecha por defecto: hoy
      respFecha.value = new Date().toISOString().split("T")[0];

      const storedEntradas = localStorage.getItem('entradas');
      if (storedEntradas) entradas = JSON.parse(storedEntradas);
      renderHistorial();
    });

    function toggleHistorial() {
      historialSection.style.display = (historialSection.style.display === 'block') ? 'none' : 'block';
    }

    function renderHistorial() {
      tablaHistorialBody.innerHTML = '';
      if (!entradas.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = "No hay entradas registradas aún.";
        tr.appendChild(td);
        tablaHistorialBody.appendChild(tr);
        return;
      }
      entradas.forEach(ent => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ent.id}</td>
          <td>${ent.ordenId}</td>
          <td>${ent.fechaIngreso}</td>
          <td>${Number(ent.totalEntrada).toFixed(2)}</td>
          <td><button class="btn-view-acta" onclick="verActa(${ent.id})">Ver Acta</button></td>
        `;
        tablaHistorialBody.appendChild(tr);
      });
    }

    function cargarOrden() {
      const id = parseInt(ordenCompraSelect.value, 10);
      if (!id) { alert("Seleccione una orden de compra."); return; }
      compraSeleccionada = compras.find(c => c.id === id);
      if (!compraSeleccionada) { alert("Orden no encontrada."); return; }

      ordenInfoDiv.style.display = 'block';
      let html = `<p><strong>Orden:</strong> ${compraSeleccionada.id}</p>`;
      html    += `<p><strong>Fecha:</strong> ${compraSeleccionada.fecha}</p>`;

      const storedProveedores = localStorage.getItem('proveedores');
      if (storedProveedores) {
        const proveedores = JSON.parse(storedProveedores);
        const prov = proveedores.find(p => p.id == compraSeleccionada.proveedorId);
        if (prov) {
          html += `<p><strong>Proveedor:</strong> ${prov.nombre}</p>`;
          html += `<p><strong>Dirección:</strong> ${prov.direccion || ""}</p>`;
          html += `<p><strong>Ciudad:</strong> ${prov.ciudad || ""}</p>`;
          html += `<p><strong>Contacto:</strong> ${prov.asesor || ""}</p>`;
        }
      }
      detalleOrdenDiv.innerHTML = html;

      tablaEntradasBody.innerHTML = "";
      compraSeleccionada.items.forEach(item => agregarFilaDesdeOrden(item));
      recalcularTotalEntrada();
    }

    function agregarFilaDesdeOrden(item) {
      let listaProductos = JSON.parse(localStorage.getItem('medicamentos') || '[]');
      const prod = listaProductos.find(p => String(p.codigo) === String(item.productoCodigo));
      const nombreProducto = prod ? prod.nombre : "Desconocido";

      const row = document.createElement('tr');

      // Producto
      const tdProducto = document.createElement('td');
      tdProducto.textContent = item.productoCodigo + " - " + nombreProducto;
      row.appendChild(tdProducto);

      // Unidad
      const tdUnidad = document.createElement('td');
      tdUnidad.textContent = item.unidad || "";
      row.appendChild(tdUnidad);

      // Cantidad (required)
      const tdCantidad = document.createElement('td');
      const inputCantidad = document.createElement('input');
      inputCantidad.type = 'number'; inputCantidad.min = '1'; inputCantidad.value = item.cantidad;
      inputCantidad.required = true;
      tdCantidad.appendChild(inputCantidad);
      row.appendChild(tdCantidad);

      // Precio Unitario (required)
      const tdPrecio = document.createElement('td');
      const inputPrecio = document.createElement('input');
      inputPrecio.type = 'number'; inputPrecio.step = '0.01'; inputPrecio.min = '0';
      inputPrecio.value = item.precioUnitario; inputPrecio.required = true;
      tdPrecio.appendChild(inputPrecio);
      row.appendChild(tdPrecio);

      // Total Unit
      const tdTotal = document.createElement('td');
      tdTotal.textContent = (item.cantidad * item.precioUnitario).toFixed(2);
      row.appendChild(tdTotal);

      // Lote (required)
      const tdLote = document.createElement('td');
      const inputLote = document.createElement('input');
      inputLote.type = 'text'; inputLote.placeholder = "N° de Lote"; inputLote.required = true;
      tdLote.appendChild(inputLote);
      row.appendChild(tdLote);

      // Fecha Venc (required)
      const tdVenc = document.createElement('td');
      const inputVenc = document.createElement('input');
      inputVenc.type = 'date'; inputVenc.required = true;
      tdVenc.appendChild(inputVenc);
      row.appendChild(tdVenc);

      // Reg. San (required)
      const tdRegSan = document.createElement('td');
      const inputRegSan = document.createElement('input');
      inputRegSan.type = 'text'; inputRegSan.placeholder = "Reg. Sanitario"; inputRegSan.required = true;
      tdRegSan.appendChild(inputRegSan);
      row.appendChild(tdRegSan);

      // Cant. Revisada (required, numérica)
      const tdCantRev = document.createElement('td');
      const inputCantRev = document.createElement('input');
      inputCantRev.type = 'number'; inputCantRev.min = '0'; inputCantRev.step = '1';
      inputCantRev.placeholder = "Revisada"; inputCantRev.required = true;
      tdCantRev.appendChild(inputCantRev);
      row.appendChild(tdCantRev);

      // Transp/Manip
      const tdTransp = document.createElement('td');
      const selectTransp = document.createElement('select');
      ["S","N"].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selectTransp.appendChild(o); });
      tdTransp.appendChild(selectTransp);
      row.appendChild(tdTransp);

      // Cadena frío
      const tdFrio = document.createElement('td');
      const selectFrio = document.createElement('select');
      ["S","N"].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selectFrio.appendChild(o); });
      tdFrio.appendChild(selectFrio);
      row.appendChild(tdFrio);

      // Aprobado
      const tdAprob = document.createElement('td');
      const selectAprob = document.createElement('select');
      ["S","N"].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selectAprob.appendChild(o); });
      tdAprob.appendChild(selectAprob);
      row.appendChild(tdAprob);

      // Acciones
      const tdActions = document.createElement('td');
      const btnDelete = document.createElement('button');
      btnDelete.type = 'button'; btnDelete.textContent = 'Eliminar'; btnDelete.classList.add('btn-delete-item');
      btnDelete.addEventListener('click', () => { row.remove(); recalcularTotalEntrada(); });
      tdActions.appendChild(btnDelete);
      row.appendChild(tdActions);

      const recalc = () => {
        const total = (parseFloat(inputCantidad.value)||0) * (parseFloat(inputPrecio.value)||0);
        tdTotal.textContent = total.toFixed(2);
        recalcularTotalEntrada();
      };
      inputCantidad.addEventListener('input', recalc);
      inputPrecio.addEventListener('input', recalc);

      tablaEntradasBody.appendChild(row);
    }

    function agregarFilaManual() {
      const row = document.createElement('tr');

      // Producto (select)
      const tdProducto = document.createElement('td');
      const selectProducto = document.createElement('select');
      const opt0 = document.createElement('option');
      opt0.value = ""; opt0.textContent = "Seleccione un producto";
      selectProducto.appendChild(opt0);

      const listaProductos = JSON.parse(localStorage.getItem('medicamentos') || '[]');
      listaProductos.forEach(p=>{
        const o=document.createElement('option');
        o.value=p.codigo; o.textContent=`${p.codigo} - ${p.nombre}`; o.dataset.unidad=p.unidad||"";
        selectProducto.appendChild(o);
      });
      tdProducto.appendChild(selectProducto);
      row.appendChild(tdProducto);

      // Unidad
      const tdUnidad = document.createElement('td');
      row.appendChild(tdUnidad);

      // Cantidad (required)
      const tdCantidad = document.createElement('td');
      const inputCantidad = document.createElement('input');
      inputCantidad.type='number'; inputCantidad.min='1'; inputCantidad.value='1'; inputCantidad.required = true;
      tdCantidad.appendChild(inputCantidad);
      row.appendChild(tdCantidad);

      // Precio unit (required)
      const tdPrecio=document.createElement('td');
      const inputPrecio=document.createElement('input');
      inputPrecio.type='number'; inputPrecio.step='0.01'; inputPrecio.min='0'; inputPrecio.required = true;
      tdPrecio.appendChild(inputPrecio);
      row.appendChild(tdPrecio);

      // Total
      const tdTotal=document.createElement('td'); tdTotal.textContent='0.00';
      row.appendChild(tdTotal);

      // Lote (required)
      const tdLote=document.createElement('td');
      const inputLote=document.createElement('input');
      inputLote.type='text'; inputLote.placeholder='N° de Lote'; inputLote.required = true;
      tdLote.appendChild(inputLote);
      row.appendChild(tdLote);

      // Fecha (required)
      const tdVenc=document.createElement('td');
      const inputVenc=document.createElement('input');
      inputVenc.type='date'; inputVenc.required = true;
      tdVenc.appendChild(inputVenc);
      row.appendChild(tdVenc);

      // Reg. San (required)
      const tdRegSan=document.createElement('td');
      const inputRegSan=document.createElement('input');
      inputRegSan.type='text'; inputRegSan.placeholder='Reg. Sanitario'; inputRegSan.required = true;
      tdRegSan.appendChild(inputRegSan);
      row.appendChild(tdRegSan);

      // Cant. Revisada (required numérica)
      const tdCantRev=document.createElement('td');
      const inputCantRev=document.createElement('input');
      inputCantRev.type='number'; inputCantRev.min='0'; inputCantRev.step='1'; inputCantRev.placeholder='Revisada'; inputCantRev.required = true;
      tdCantRev.appendChild(inputCantRev);
      row.appendChild(tdCantRev);

      // Transp/Manip
      const tdTransp=document.createElement('td');
      const selectTransp=document.createElement('select');
      ["S","N"].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selectTransp.appendChild(o); });
      tdTransp.appendChild(selectTransp);
      row.appendChild(tdTransp);

      // Cadena frío
      const tdFrio=document.createElement('td');
      const selectFrio=document.createElement('select');
      ["S","N"].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selectFrio.appendChild(o); });
      tdFrio.appendChild(selectFrio);
      row.appendChild(tdFrio);

      // Aprobado
      const tdAprob=document.createElement('td');
      const selectAprob=document.createElement('select');
      ["S","N"].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; selectAprob.appendChild(o); });
      tdAprob.appendChild(selectAprob);
      row.appendChild(tdAprob);

      // Acciones
      const tdActions=document.createElement('td');
      const btnDelete=document.createElement('button');
      btnDelete.type='button'; btnDelete.textContent='Eliminar'; btnDelete.classList.add('btn-delete-item');
      btnDelete.addEventListener('click', ()=>{ row.remove(); recalcularTotalEntrada(); });
      tdActions.appendChild(btnDelete);
      row.appendChild(tdActions);

      selectProducto.addEventListener('change', ()=>{
        const u = selectProducto.options[selectProducto.selectedIndex].dataset.unidad || "";
        tdUnidad.textContent = u;
      });
      const recalc=()=>{
        const total=(parseFloat(inputCantidad.value)||0)*(parseFloat(inputPrecio.value)||0);
        tdTotal.textContent=total.toFixed(2);
        recalcularTotalEntrada();
      };
      inputCantidad.addEventListener('input',recalc);
      inputPrecio.addEventListener('input',recalc);

      tablaEntradasBody.appendChild(row);
    }

    function recalcularTotalEntrada() {
      let total = 0;
      tablaEntradasBody.querySelectorAll('tr').forEach(row=>{
        total += parseFloat(row.children[4].textContent)||0;
      });
      totalEntradaInput.value = total.toFixed(2);
    }

    entradaForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!compraSeleccionada) { alert("Primero cargue una Orden de Compra."); return; }

      // Validar responsable
      const errores = [];
      if (!respNombre.value.trim()) errores.push("Nombre del responsable es obligatorio.");
      if (!respCargo.value.trim())  errores.push("Cargo del responsable es obligatorio.");
      if (!respFecha.value)         errores.push("Fecha del responsable es obligatoria.");

      // Validar filas
      const rows = tablaEntradasBody.querySelectorAll('tr');
      if (!rows.length) errores.push("No hay ítems en la tabla.");

      let itemsEntrada = [];
      rows.forEach((row,i)=>{
        const idx = i+1;
        // Producto
        let codigo = "", nombre = "";
        const sel = row.children[0].querySelector('select');
        if (sel) {
          if (!sel.value) { errores.push(`Fila ${idx}: seleccione un producto.`); return; }
          codigo = sel.value;
          const t = sel.options[sel.selectedIndex].textContent.split(" - ");
          nombre = t[1] || "Desconocido";
        } else {
          const t = (row.children[0].textContent||"").split(" - ");
          codigo = t[0]; nombre = t[1] || "";
        }

        const unidad = row.children[1].textContent;
        const cant   = parseFloat(row.children[2].querySelector('input').value)||0;
        const precio = parseFloat(row.children[3].querySelector('input').value)||0;
        const total  = parseFloat(row.children[4].textContent)||0;
        const lote   = row.children[5].querySelector('input').value.trim();
        const fvenc  = row.children[6].querySelector('input').value;
        const reg    = row.children[7].querySelector('input').value.trim();
        const crev   = parseFloat(row.children[8].querySelector('input').value);

        if (cant <= 0)  errores.push(`Fila ${idx}: cantidad inválida.`);
        if (precio < 0) errores.push(`Fila ${idx}: precio inválido.`);
        if (!lote)      errores.push(`Fila ${idx}: Lote obligatorio.`);
        if (!fvenc)     errores.push(`Fila ${idx}: Fecha de vencimiento obligatoria.`);
        if (!reg)       errores.push(`Fila ${idx}: Registro sanitario obligatorio.`);
        if (isNaN(crev) || crev < 0) errores.push(`Fila ${idx}: Cantidad revisada inválida.`);
        if (!isNaN(crev) && crev > cant) errores.push(`Fila ${idx}: Cant. revisada no puede ser mayor que la cantidad.`);

        const transp = row.children[9].querySelector('select').value;
        const frio   = row.children[10].querySelector('select').value;
        const apr    = row.children[11].querySelector('select').value;

        itemsEntrada.push({
          productoCodigo: codigo,
          productoNombre: nombre,
          unidad,
          cantidad: cant,
          precioUnitario: precio,
          total,
          lote,
          fechaVenc: fvenc,
          regSan: reg,
          cantRevisada: crev,
          transpManip: transp,
          cadenaFrio: frio,
          aprobado: apr
        });
      });

      if (errores.length) {
        alert("Corrige los siguientes puntos:\n\n- " + errores.join("\n- "));
        return;
      }

      const nuevaEntrada = {
        id: Date.now(),
        ordenId: compraSeleccionada.id,
        fechaIngreso: new Date().toISOString().split("T")[0],
        items: itemsEntrada,
        totalEntrada: parseFloat(totalEntradaInput.value)||0,
        responsable: {
          nombre: respNombre.value.trim(),
          cargo : respCargo.value.trim(),
          fecha : respFecha.value
        }
      };

      const guardadas = JSON.parse(localStorage.getItem('entradas') || '[]');
      guardadas.push(nuevaEntrada);
      localStorage.setItem('entradas', JSON.stringify(guardadas));
      entradas = guardadas;

      alert("Entrada guardada con éxito. Puedes generar el acta o ver el historial.");
      entradaForm.reset();
      tablaEntradasBody.innerHTML = "";
      totalEntradaInput.value = "";
      ordenInfoDiv.style.display = 'none';
      compraSeleccionada = null;
      ordenCompraSelect.value = "";
      // restaurar fecha de hoy en el form de firma
      respFecha.value = new Date().toISOString().split("T")[0];

      renderHistorial();
    });

    function generarActa() {
      const rows = tablaEntradasBody.querySelectorAll('tr');
      if (!rows.length) { alert("No hay ítems para generar el acta."); return; }
      if (!compraSeleccionada) { alert("No hay orden de compra cargada."); return; }
      alert("Ejemplo: aquí generas el HTML del acta con la info actual (opcional).");
    }

    function verActa(entradaId) {
      const ent = entradas.find(e=>e.id===entradaId);
      if(!ent){ alert("Entrada no encontrada."); return; }

      let provNombre = "";
      const compraRef = compras.find(c=>c.id===ent.ordenId);
      if (compraRef) {
        const proveedores = JSON.parse(localStorage.getItem('proveedores') || '[]');
        const prov = proveedores.find(p=>p.id==compraRef.proveedorId);
        if (prov) provNombre = prov.nombre;
      }

      let html = `
      <html><head><meta charset="UTF-8"><title>Acta #${ent.id}</title>
      <style>
        body{font-family:Arial,sans-serif;margin:20px;color:#333}
        h1{text-align:center;color:#008000}
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th,td{border:1px solid #ccc;padding:8px;text-align:left}
        thead{background:#e9ecef}
        .firma{margin-top:24px;border:1px solid #e0e0e0;padding:12px;border-radius:8px;background:#fafafa}
        .firma p{margin:6px 0;}
        .text-right{text-align:right}
      </style></head><body>
      <h1>Acta de Recepción</h1>
      <p><strong>ID Entrada:</strong> ${ent.id}</p>
      <p><strong>Orden ID:</strong> ${ent.ordenId}</p>
      <p><strong>Fecha Ingreso:</strong> ${ent.fechaIngreso}</p>
      <p><strong>Proveedor:</strong> ${provNombre}</p>
      <table><thead><tr>
        <th>Producto</th><th>Unidad</th><th>Cant.</th><th>Precio</th>
        <th>Total</th><th>Lote</th><th>F.Venc</th><th>Reg.San</th>
        <th>Revisada</th><th>Transp/Manip</th><th>Cadena Frío</th><th>Aprobado</th>
      </tr></thead><tbody>`;
      ent.items.forEach(it=>{
        html += `<tr>
          <td>${it.productoCodigo} - ${it.productoNombre}</td>
          <td>${it.unidad}</td>
          <td>${it.cantidad}</td>
          <td>${Number(it.precioUnitario).toFixed(2)}</td>
          <td>${Number(it.total).toFixed(2)}</td>
          <td>${it.lote}</td>
          <td>${it.fechaVenc||""}</td>
          <td>${it.regSan||""}</td>
          <td>${it.cantRevisada||""}</td>
          <td>${it.transpManip||""}</td>
          <td>${it.cadenaFrio||""}</td>
          <td>${it.aprobado||""}</td>
        </tr>`;
      });
      html += `</tbody></table>
      <h2 class="text-right">Total Entrada: ${Number(ent.totalEntrada).toFixed(2)}</h2>
      <div class="firma">
        <p><strong>Firma del Responsable de Recepción</strong></p>
        <p><strong>Nombre:</strong> ${ent.responsable?.nombre || ""}</p>
        <p><strong>Cargo:</strong> ${ent.responsable?.cargo  || ""}</p>
        <p><strong>Fecha:</strong> ${ent.responsable?.fecha  || ""}</p>
      </div>
      </body></html>`;

      const w = window.open('','_blank');
      w.document.write(html); w.document.close();
    }
  </script>
</body>
</html>
